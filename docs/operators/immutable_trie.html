

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>ImmutableTrie &mdash; Python Inference Script 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Python Inference Script
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Model Authoring</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="a_list_of_operators.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/a_list_of_tutorials.html">Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../backends/cpython.html">CPython Backend üêç</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/libtorch.html">LibTorch Backend üî•</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/onnxruntime.html">ONNXRuntime Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/native_cpp_library.html">Native C++ Library</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev/why_we_build_pyis.html">Why We Build PyIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/build_from_source.html">Build from Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/house_keeping.html">House Keeping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/build_libtorch.html">Build LibTorch for JIT</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Python Inference Script</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>ImmutableTrie</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/operators/immutable_trie.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="immutabletrie">
<h1>ImmutableTrie<a class="headerlink" href="#immutabletrie" title="Permalink to this headline">¬∂</a></h1>
<p>Immutable Trie has a much smaller memory footprint, compared to cedar trie. See the benchmark section for details.</p>
<div class="section" id="apis">
<h2>APIs<a class="headerlink" href="#apis" title="Permalink to this headline">¬∂</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="pyis.python.ops.ImmutableTrie">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">pyis.python.ops.</span></span><span class="sig-name descname"><span class="pre">ImmutableTrie</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">ops.ImmutableTrie</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#pyis.python.ops.ImmutableTrie" title="Permalink to this definition">¬∂</a></dt>
<dd><p>An Implementation of compile-stype immutable trie.</p>
<p>Constructs an empty immutable trie.</p>
<dl class="py method">
<dt class="sig sig-object py" id="pyis.python.ops.ImmutableTrie.compile">
<em class="property"><span class="pre">static</span> </em><span class="sig-name descname"><span class="pre">compile</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span> </span><span class="pre">int</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#pyis.python.ops.ImmutableTrie.compile" title="Permalink to this definition">¬∂</a></dt>
<dd><p>Compile a list of key-value pairs into a immutable trie file. This process could costs lots of memory.
Values in the list should not exceeded the presenting capacity of unsigned 32bit integer.
Throws RuntimeError if compile process could not finish (e.g. file cannot write).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data</strong> (<em>List</em><em>[</em><em>Tuple</em><em>[</em><em>str</em><em>, </em><em>int</em><em>]</em><em>]</em>) ‚Äì The key-value pairs to be compiled.</p></li>
<li><p><strong>path</strong> (<em>str</em>) ‚Äì The path the compiled file to be stored.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyis.python.ops.ImmutableTrie.contains">
<span class="sig-name descname"><span class="pre">contains</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">ops.ImmutableTrie</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bool</span></span></span><a class="headerlink" href="#pyis.python.ops.ImmutableTrie.contains" title="Permalink to this definition">¬∂</a></dt>
<dd><p>Look for a specific key.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>key</strong> (<em>str</em>) ‚Äì The specific key to look up.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>True if the trie contains the key, False otherwise.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>result (bool)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyis.python.ops.ImmutableTrie.items">
<span class="sig-name descname"><span class="pre">items</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">ops.ImmutableTrie</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span> </span><span class="pre">int</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#pyis.python.ops.ImmutableTrie.items" title="Permalink to this definition">¬∂</a></dt>
<dd><p>Dump all key-value pairs from the trie.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>All key-value pairs in the trie.</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>data (List[Tuple[str, int]])</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyis.python.ops.ImmutableTrie.load">
<span class="sig-name descname"><span class="pre">load</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">ops.ImmutableTrie</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#pyis.python.ops.ImmutableTrie.load" title="Permalink to this definition">¬∂</a></dt>
<dd><p>Load the trie from a pre-compiled binary file.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>str</em>) ‚Äì Binary file path.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyis.python.ops.ImmutableTrie.load_items">
<span class="sig-name descname"><span class="pre">load_items</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">ops.ImmutableTrie</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span> </span><span class="pre">int</span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">None</span></span></span><a class="headerlink" href="#pyis.python.ops.ImmutableTrie.load_items" title="Permalink to this definition">¬∂</a></dt>
<dd><p>Re-construct the trie with given data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>data</strong> (<em>List</em><em>[</em><em>Tuple</em><em>[</em><em>str</em><em>, </em><em>int</em><em>]</em><em>]</em>) ‚Äì Key-value pairs to construct the new trie.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyis.python.ops.ImmutableTrie.lookup">
<span class="sig-name descname"><span class="pre">lookup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">ops.ImmutableTrie</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">int</span></span></span><a class="headerlink" href="#pyis.python.ops.ImmutableTrie.lookup" title="Permalink to this definition">¬∂</a></dt>
<dd><p>Look up a specific key from the trie. Return the corrsponding value if found. Throws RuntimeError
if trie is not initialized or the key not found.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>key</strong> (<em>str</em>) ‚Äì The specific key to look up.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The corrsponding value.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>value (int)</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¬∂</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c1"># Licensed under the MIT license.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pyis.python</span> <span class="kn">import</span> <span class="n">ops</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Alpha&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Delta&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;AlphaBeta&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>

<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ops</span><span class="o">.</span><span class="n">ImmutableTrie</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;tmp/trie.bin&#39;</span><span class="p">)</span>

<span class="n">trie</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">ImmutableTrie</span><span class="p">()</span>
<span class="n">trie</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;tmp/trie.bin&#39;</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">trie</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

<span class="mi">1</span> <span class="o">==</span> <span class="n">trie</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Alpha&#39;</span><span class="p">)</span>
<span class="mi">2</span> <span class="o">==</span> <span class="n">trie</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">)</span>
<span class="mi">4</span> <span class="o">==</span> <span class="n">trie</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;AlphaBeta&#39;</span><span class="p">)</span>
<span class="n">trie</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">&#39;NonExists&#39;</span><span class="p">)</span> <span class="c1"># raise RuntimeError  </span>
</pre></div>
</div>
</div>
<div class="section" id="benchmark">
<h2>Benchmark<a class="headerlink" href="#benchmark" title="Permalink to this headline">¬∂</a></h2>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">Performance Comparsion of Immutable Trie and Cedar Trie</span><a class="headerlink" href="#id1" title="Permalink to this table">¬∂</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Test Item</p></th>
<th class="head"><p>Immutable Trie</p></th>
<th class="head"><p>Cedar Trie</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Construction Time</p></td>
<td><p>49.319 sec</p></td>
<td><p>15.245 sec</p></td>
</tr>
<tr class="row-odd"><td><p>Memory used during construction</p></td>
<td><p>5.1 GB</p></td>
<td><p>199 MB</p></td>
</tr>
<tr class="row-even"><td><p>Runtime memory footprint</p></td>
<td><p>85 MB</p></td>
<td><p>170 MB</p></td>
</tr>
<tr class="row-odd"><td><p>Query all keys</p></td>
<td><p>0.192 sec</p></td>
<td><p>0.979 sec</p></td>
</tr>
<tr class="row-even"><td><p>Dump</p></td>
<td><p>1.05 sec</p></td>
<td><p>1.428 sec</p></td>
</tr>
</tbody>
</table>
<p>The test dataset contains 5,000,000 randomly generated strings, length from 5 to 20 characters including upper/lower characters and digits. The following is the script used to generate the dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c1"># Licensed under the MIT license.</span>

<span class="c1">#! /bin/usr/env python3</span>
<span class="c1"># -*- encoding: ascii -*-</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">randstr</span><span class="p">():</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">)]</span> <span class="o">+</span> \
          <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;dict.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5000000</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">randstr</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Inference Team, STCA, Microsoft.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>